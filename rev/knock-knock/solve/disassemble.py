from capstone import *

# BPF code, disassemble

bpf = b'\x28\x00\x00\x00\x0c\x00\x00\x00\x15\x00\x00\x1f\x00\x08\x00\x00\x30\x00\x00\x00\x17\x00\x00\x00\x15\x00\x00\x1d\x06\x00\x00\x00\x28\x00\x00\x00\x14\x00\x00\x00\x45\x00\x1b\x00\xff\x1f\x00\x00\xb1\x00\x00\x00\x0e\x00\x00\x00\x50\x00\x00\x00\x1a\x00\x00\x00\x54\x00\x00\x00\xf0\x00\x00\x00\x74\x00\x00\x00\x02\x00\x00\x00\x0c\x00\x00\x00\x00\x00\x00\x00\x07\x00\x00\x00\x00\x00\x00\x00\x40\x00\x00\x00\x0e\x00\x00\x00\x15\x00\x00\x13\x01\xfe\x00\xff\xb1\x00\x00\x00\x0e\x00\x00\x00\x50\x00\x00\x00\x1a\x00\x00\x00\x54\x00\x00\x00\xf0\x00\x00\x00\x74\x00\x00\x00\x02\x00\x00\x00\x04\x00\x00\x00\x04\x00\x00\x00\x0c\x00\x00\x00\x00\x00\x00\x00\x07\x00\x00\x00\x00\x00\x00\x00\x40\x00\x00\x00\x0e\x00\x00\x00\x15\x00\x00\x0a\x64\x62\x6b\x73\xb1\x00\x00\x00\x0e\x00\x00\x00\x50\x00\x00\x00\x1a\x00\x00\x00\x54\x00\x00\x00\xf0\x00\x00\x00\x74\x00\x00\x00\x02\x00\x00\x00\x04\x00\x00\x00\x0c\x00\x00\x00\x0c\x00\x00\x00\x00\x00\x00\x00\x07\x00\x00\x00\x00\x00\x00\x00\x40\x00\x00\x00\x0e\x00\x00\x00\x15\x00\x00\x01\x7a\x67\x6f\x64\x06\x00\x00\x00\x00\x00\x04\x00\x06\x00\x00\x00\x00\x00\x00\x00'
# (Copied from binary)

dis = Cs(CS_ARCH_BPF, CS_MODE_BPF_CLASSIC)

# break bpf into chunks of 8 bytes (format is: op op jt jf imm imm imm imm )
bpfgroup = [bpf[i:i+8] for i in range(0,len(bpf), 8)]

linenum = 0
# unique instruction, where it was added in classic BPF, but now isn't an instruction that follows RFC (hence capstone doesn't disassemble)
# https://github.com/torvalds/linux/blob/3f31a806a62e44f7498e2d17719c03f816553f11/net/core/filter.c#L793
# https://github.com/torvalds/linux/blob/3f31a806a62e44f7498e2d17719c03f816553f11/include/uapi/linux/bpf_common.h#L8
BROKEN_INS = b'\xb1\x00\x00\x00\x0e\x00\x00\x00' 

for code in bpfgroup:
    line = list(dis.disasm(code, 0))
    if line:
        for ins in line:
            print(f"{linenum}: {ins.mnemonic} {ins.op_str}")
            linenum += 1
    else:
        if code == BROKEN_INS:
            print(f"{linenum}: ldxb 4*([14]&0xf)")
            linenum += 1
        else:
            print(f"failed to disassemble {code} @ {linenum}")
            continue